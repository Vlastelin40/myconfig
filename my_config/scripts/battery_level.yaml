  battery_level_check:
    alias: Battery Level Check
    sequence:
      - service: script.turn_on
        data:
          entity_id: >
            {% set num_low_bat = expand('group.batteries') | selectattr('state','<=','50') | map(attribute='attributes.name') | list | count %}
            {% if num_low_bat >0 %}
              script.battery_level_low
            {% else %}
              script.battery_level_ok
            {% endif%}

  battery_level_low:
    alias: Battery Level Low
    sequence:
      - service: notify.telegram
        data:
          message: >
            {% set low_bat = expand('group.batteries') | selectattr('state','<=',states('input_number.battery_low_level')) | map(attribute='attributes.name') | list | join(', ') %}
          
            {% set num_low_bat = expand('group.batteries') | selectattr('state','<=',states('input_number.battery_low_level')) | map(attribute='attributes.name') | list | count %}
            {{"\U0001f6a8"}} Низкий заряд батарей ({{ num_low_bat}}шт): {{low_bat}}


  
  battery_level_ok:
    alias: Battery Level Ok
    sequence:
      - service: notify.telegram
        data:
          message: "\U0001f50b Батарей с уровнем заряда ниже {{states('input_number.battery_low_level')|int(0)}}% не найдено!"