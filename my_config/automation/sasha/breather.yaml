# #####################################################################################
#
# SASHA - breather
#
# #####################################################################################
# Sasha- breather auto co2
# ##################################
  - alias: sasha_breather_auto_co2
    id: sasha_breather_auto_co2
    initial_state: true
    trigger:
      - platform: time_pattern
        minutes: '/3'
    condition:
      - condition: state
        entity_id: switch.breather_auto_s
        state: 'on'
      - condition: not
        conditions:
          - condition: state
            entity_id: switch.breather_s_last_toggle_by_user
            state: 'on'
    action:
      - choose:
          - conditions:
              - condition: state
                entity_id: binary_sensor.0x158d00025370d1_contact
                state: 'off'
              - condition: numeric_state
                entity_id: sensor.d1mini_co2_s_co2
                above: input_number.co2_high_limit
              - condition: state
                entity_id: binary_sensor.breather_s
                state: 'off'
              - condition: state
                entity_id: switch.security_mode
                state: 'off'
            sequence:
              - service: fan.turn_on
                entity_id: fan.breather_s
              - condition: numeric_state
                entity_id: sensor.d1mini_co2_s_co2
                above: input_number.co2_high_limit
              - condition: state
                entity_id: switch.breather_auto_speed_s
                state: 'on'
              - service: fan.set_percentage
                entity_id: fan.breather_s
                data:
                  percentage: "{{states('sensor.breather_set_speed_s')|int(0) }}"

          - conditions:
              - condition: state
                entity_id: binary_sensor.0x158d00025370d1_contact
                state: 'off'
              - condition: numeric_state
                entity_id: sensor.d1mini_co2_s_co2
                below: input_number.co2_low_limit
              - condition: state
                entity_id: binary_sensor.breather_s
                state: 'on'
            sequence:
              - service: fan.turn_off
                entity_id: fan.breather_s
                
          - conditions:
              - condition: state
                entity_id: binary_sensor.0x158d00025370d1_contact
                state: 'on'
              - condition: state
                entity_id: binary_sensor.breather_s
                state: 'on'
            sequence:
              - service: fan.turn_off
                entity_id: fan.breather_s
