# #####################################################################################
#
# SYSTEM - WiFi Devices
#
# #####################################################################################
# System - Critical WiFi Devices state - Unavailable
# ##################################
  - alias: system_critical_wifi_devices_unavailable
    id: system_critical_wifi_devices_unavailable
    initial_state: true
    mode: queued
    max_exceeded: silent
    max: 25
    trigger:
      - platform: state
        entity_id:
          - light.square_led_v
          - light.square_led_s
          - light.round_led_mb
          - light.round_led_k
          - light.round_led_hs
          - light.led_strip_hb
          - light.led_strip_entrance_hb
          - light.bedside
          - light.led_strip_bed_sandra_v_hk
          - light.led_strip_bed_dima_v_hk
          - switch.1pm_led_mb
          - switch.shelly_1pm_led_v
          - light.led_color_v
          - light.led_color_mb
          - light.led_white_s
          - light.led_white_mb
          - fan.purifier2s
          - switch.server_plug_hb
          #- switch.shp2_socket_1_relay
          #- switch.shp2_socket_2_relay
          #- switch.shp6_socket_1_relay
          #- switch.shp6_socket_2_relay
          - switch.shelly_1pm_led_s
          #- light.round_led_secondary_hs
          - switch.sonoff_pow_r2_1_relay
          - switch.sonoff_pow_r2_2_relay
          - switch.esp8266_hood_k_light
          - switch.sonoff_mini_1_relay
          - switch.sonoff_mini_4_relay
          - switch.d1mini_domofon_open
          - switch.d1mini_light_l_relay
        to: "unavailable"
        for:
          minutes: 1
      # - platform: state
      #   entity_id:
      #     - binary_sensor.bed_strip_dima_v
      #     - binary_sensor.bed_strip_sandra_v
      #   to: 'off'
      #   for:
      #     minutes: 1
    action:
      - service: notify.telegram
        data:
          message: "\U0000274C {{trigger.to_state.attributes.friendly_name}}: {{trigger.from_state.state}} -> {{trigger.to_state.state}}"
  
# ##################################
# System - Critical WiFi Devices state - available
# ##################################
  - alias: system_critical_wifi_devices_available
    id: system_critical_wifi_devices_available
    initial_state: true
    max_exceeded: silent
    max: 25
    trigger:
      - platform: state
        entity_id:
          - light.square_led_v
          - light.square_led_s
          - light.round_led_mb
          - light.round_led_k
          - light.round_led_hs
          - light.led_strip_hb
          - light.led_strip_entrance_hb
          - light.bedside
          - light.led_strip_bed_sandra_v_hk
          - light.led_strip_bed_dima_v_hk
          - switch.1pm_led_mb
          - switch.shelly_1pm_led_v
          - light.led_color_v
          - light.led_color_mb
          - light.led_white_s
          - light.led_white_mb
          - fan.purifier2s
          - switch.server_plug_hb
          #- switch.shp2_socket_1_relay
          #- switch.shp2_socket_2_relay
          #- switch.shp6_socket_1_relay
          #- switch.shp6_socket_2_relay
          - switch.shelly_1pm_led_s
          #- light.round_led_secondary_hs
          - switch.sonoff_pow_r2_1_relay
          - switch.sonoff_pow_r2_2_relay
          - switch.esp8266_hood_k_light
          - switch.sonoff_mini_1_relay
          - switch.d1mini_domofon_open
          - switch.d1mini_light_l_relay
        from: "unavailable"
      # - platform: state
      #   entity_id:
      #     - binary_sensor.bed_strip_dima_v
      #     - binary_sensor.bed_strip_sandra_v
      #   from: 'off'
    condition:
      - condition: template
        value_template: "{{(trigger.to_state.last_changed - trigger.from_state.last_changed).total_seconds() > 60 }}"
    action:
      - service: notify.telegram
        data:
          message: "\U00002705 {{trigger.to_state.name}}: {{trigger.from_state.state}} -> {{trigger.to_state.state}}"
  
# ##################################
# System - Critical Switches toggle
# ##################################
  - alias: system_critical_switches_toggle
    id: system_critical_switches_toggle
    initial_state: true
    max_exceeded: silent
    mode: queued
    max: 10
    trigger:
      - platform: state
        entity_id:
          - switch.0x158d00023e5812_switch
          - switch.esp32_node_b_relay_5
          - switch.shelly_1pm_led_s
          - switch.digma_strip_hb_relay1
          - switch.digma_strip_hb_relay2
          - switch.digma_strip_hb_relay3
          - switch.digma_strip_hb_relay4
          - switch.0x158d00039bd56d_switch
          - switch.0x158d0002a36433_channel_1
          - switch.0x158d0002a36f7f_channel_2
          - switch.1pm_led_mb
          - switch.shelly_1pm_led_v
          - switch.0x158d0001a248e3_channel_1
          - switch.0x158d0001a248e3_channel_2
        to: "off"
        for:
          seconds: 30
    action:
      - service: switch.turn_on
        data:
          entity_id: "{{ trigger.entity_id }}"
      - service: notify.telegram
        data:
          message: "\U00002705 Включение - {{trigger.to_state.name}}"

# ##################################
# System - CO2 Reconnect
# ##################################
  # - alias: system_co2_monitors_reconnect
  #   id: system_co2_monitors_reconnect
  #   initial_state: true
  #   max_exceeded: silent
  #   mode: queued
  #   max: 10
  #   trigger:
  #     - platform: state
  #       entity_id: sensor.cgllc_cgdn1_89d7_co2_density
  #       to: 'unavailable'
  #       for:
  #         minutes: 1
  #       id: 'air_s'
  #     - platform: state
  #       entity_id: sensor.cgllc_cgdn1_8ee1_co2_density
  #       to: 'unavailable'
  #       for:
  #         minutes: 1
  #       id: 'air_mb'
  #   action:
  #     - choose:
  #         - conditions:
  #             - condition: trigger
  #               id: 'air_s'
  #           sequence:
  #             - service: unifi.reconnect_client
  #               data:
  #                 device_id: 3a4b98a38681bd64484b2a4b45befd6d
  #         - conditions:
  #             - condition: trigger
  #               id: 'air_mb'
  #           sequence:
  #             - service: unifi.reconnect_client
  #               data:
  #                 device_id: 3e9239fc946fd8c4190a9c8c8b3b17d3
  
  
# ##################################
# System - Bed Strips restart
# ##################################
  - alias: system_bed_strips_restart
    id: system_bed_strips_restart
    initial_state: false
    max_exceeded: silent
    trigger:
      - platform: time_pattern
        hours: '/1'
    action:
      - if:
          - condition: state
            entity_id: switch.led_strip_bed_sandra_v_restart_key
            state: 'on'
        then:
          - service: switch.turn_off
            entity_id: switch.0x158d0001a248e3_channel_2
          - delay: 00:00:15
          - service: switch.turn_on
            entity_id: switch.0x158d0001a248e3_channel_2
      - if:
          - condition: state
            entity_id: switch.led_strip_bed_dima_v_restart_key
            state: 'on'
        then:
          - service: switch.turn_off
            entity_id: switch.0x158d0001a248e3_channel_1
          - delay: 00:00:15
          - service: switch.turn_on
            entity_id: switch.0x158d0001a248e3_channel_1
      - delay: 00:00:15
      - service: homeassistant.reload_config_entry
        data:
          entry_id: 3db3d77cd2392c85523b6d212d5cf107
      - service: homeassistant.reload_config_entry
        data:
          entry_id: a3add87af9575143575396fd33e4f0a2
          

# ##################################
# System - Bed Strips restart (WH)
# ##################################
  - alias: system_bed_strips_restart_wh
    id: system_bed_strips_restart_wh
    initial_state: false
    max_exceeded: silent
    trigger:
      - platform: webhook
        webhook_id: 'led_strip_bed_dima'
        id: 'id_dima'
      - platform: webhook
        webhook_id: 'led_strip_bed_sandra'
        id: 'id_sandra'
    action:
      - variables:
          status_from: >- 
              {{ iif(trigger.json.heartbeat is not none and trigger.json.heartbeat.status | int(0) == 1, 'online', 'offline', 'offline') }}
      - condition: template
        value_template: "{{ status_from == 'offline'}}"
      - choose:
          - conditions:
              - condition: trigger
                id: 'id_dima'
            sequence:
              - condition: state
                entity_id: switch.led_strip_bed_dima_v_restart_key
                state: 'on'
              - service: switch.turn_off
                entity_id: switch.0x158d0001a248e3_channel_1
              - delay: 00:00:15
              - service: switch.turn_on
                entity_id: switch.0x158d0001a248e3_channel_1
              - delay: 00:00:15
              - service: homeassistant.reload_config_entry
                data:
                  entry_id: a3add87af9575143575396fd33e4f0a2
              - service: notify.telegram
                data:
                  message: "\U00002705 Перезапуск Ленты Дима (вебхук)"
          - conditions:
              - condition: trigger
                id: 'id_sandra'
            sequence:
              - condition: state
                entity_id: switch.led_strip_bed_sandra_v_restart_key
                state: 'on'
              - service: switch.turn_off
                entity_id: switch.0x158d0001a248e3_channel_2
              - delay: 00:00:15
              - service: switch.turn_on
                entity_id: switch.0x158d0001a248e3_channel_2
              - delay: 00:00:15
              - service: homeassistant.reload_config_entry
                data:
                  entry_id: 3db3d77cd2392c85523b6d212d5cf107
              - service: notify.telegram
                data:
                  message: "\U00002705 Перезапуск Ленты Сандра (вебхук)"

